---
title: "ã€ŒNSFileVersionã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯å¿…ãšã—ã‚‚æ›´æ–°æ—¥ãŒæœ€æ–°ã§ã¯ãªã„ã€ä»®èª¬"
emoji: "ğŸ—‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["iOS", "UIDocument"]
published: true
---

# æ¦‚è¦ãƒ»ä»®èª¬
UIDocumentã‚’iCloud Documentsã¨ã—ã¦ä¿å­˜ã—ã¦ãŠã‚Šè¤‡æ•°ã®ãƒ‡ãƒã‚¤ã‚¹ã§åŒæ™‚ã«ä¿å­˜ãŒåŒæœŸã•ã‚ŒãŸå ´åˆã¯ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’èµ·ã“ã—ã¾ã™ã€‚
[UIDocument.documentState](https://developer.apple.com/documentation/uikit/uidocument/1619982-documentstate)ãŒ[inConflict](https://developer.apple.com/documentation/uikit/uidocument/state/1619972-inconflict)ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã§ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆçŠ¶æ…‹ã‹ã©ã†ã‹åˆ†ã‹ã‚‹ãŸã‚ã€ã“ã®çŠ¶æ…‹ã®ã¨ãã«ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºã‚’è¡Œã„ã¾ã™ã€‚

ã“ã®éš›ã®æˆ¦ç•¥ã¨ã—ã¦ã¯

- ãƒãƒ¼ã‚¸æˆ¦ç•¥
- å¾Œå‹ã¡(Last Writers Win)æˆ¦ç•¥
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºãƒãƒ³ãƒ‰ãƒ©ã‚’æç¤ºã™ã‚‹æˆ¦ç•¥

ç­‰ãŒã‚ã‚Šã¾ã™ãŒã€æœ€ã‚‚ãƒãƒ”ãƒ¥ãƒ©ãƒ¼ãªã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºãŒå¾Œå‹ã¡æˆ¦ç•¥ã§ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚

ã“ã®ã‚·ãƒ¼ãƒ³ã§ç™»å ´ã™ã‚‹ã®ãŒ[NSFileVersion](https://developer.apple.com/documentation/foundation/nsfileversion)ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚ã“ã‚Œã¯1ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚‹ä¸€æ™‚ç‚¹ã§ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’è¡¨ç¾ã—ã¦ãŠã‚Šã€å„ç¨®å±æ€§ã‚’çªãåˆã‚ã›ã¦ã©ã®ã‚ˆã†ã«ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºã™ã¹ãã‹ã‚’æ±ºå®šã—ã¦ã„ãã¾ã™ã€‚æ™®é€šã«è€ƒãˆã‚‹ã¨[NSFileVersion.currentVersionOfItem(at:)](https://developer.apple.com/documentation/foundation/nsfileversion/1412963-currentversionofitem)ã‚’è¦‹ã‚Œã°æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ‰‹ã«å…¥ã‚‹ã®ã§ã€ãã‚Œã‚’å¸¸ã«å‹è€…ã«ã™ã‚‹è§£æ±ºã‚’è¡Œãˆã°è‰¯ã„ã‚ˆã†ã«è€ƒãˆã‚‹ã®ã§ã™ãŒã€ã©ã†ã‚„ã‚‰ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒèµ·ã“ã£ãŸå ´åˆã¯å¿…ãšã—ã‚‚æœ€æ–°ã®(=æ›´æ–°æ—¥ãŒæ–°ã—ã„)ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹è¨³ã§ã¯ãªã„ã®ã§ã¯ãªã„ã‹ã¨ã„ã†ä»®èª¬ã‚’ç«‹ã¦ã¾ã—ãŸã€‚

[NSFileVersion](https://developer.apple.com/documentation/foundation/nsfileversion)ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚ˆãè¦‹ã‚‹ã¨

> However, additional file versions may be created in cases where two different computers attempt to save the file to the cloud at the same time. In that case, one file is chosen as the current version and any other versions are tagged as being in conflict with the original. Conflict versions are reported to the appropriate file presenter objects and should be resolved as soon as possible so that the corresponding files can be removed from the cloud.

ã¨è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ã€‚ç°¡å˜ã«è¦ç´„ã™ã‚‹ã¨ã€ŒåŒæ™‚ã«å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã¯ç‰‡æ–¹ã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã—ã¦é¸æŠã—ã€ç‰‡æ–¹ã‚’ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã—ã¦ã‚¿ã‚°ä»˜ã‘ã™ã‚‹ã€ã¨è¨€ã£ã¦ã„ã‚‹ã®ã§ã™ãŒã€é‡è¦ãªã®ã¯**åŒæ™‚ã«å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯å¤‰æ›´æ—¥ãŒæ–°ã—ã„ã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã—ã¦é¸æŠã™ã‚‹**ã¨è¨€ã£ã¦ã„ãªã„ã“ã¨ã§ã™ã€‚

åŒæ§˜ã«[Resolving Document Version Conflicts](https://developer.apple.com/library/archive/documentation/DataManagement/Conceptual/DocumentBasedAppPGiOS/ResolveVersionConflicts/ResolveVersionConflicts.html)ã®Larning About Document Version Conflitsã®2æ®µè½ç›®ã‚’è¦‹ã¦ã„ãã¨ä¸‹è¨˜ã®ã‚ˆã†ã«è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ã€‚

> You learn about the conflicting versions of a document through two class methods of the NSFileVersion class. The currentVersionOfItemAtURL: method returns an NSFileVersion object representing whatâ€™s referred to as the current file; the current file is chosen by iCloud on some basis as the current â€œconflict winnerâ€ and is the same across all devices. (ä»¥ä¸‹ç•¥)

æ³¨ç›®ã™ã‚‹ã®ã¯`the current file is chosen by iCloud **on some basis** as the current "conflict winner"`ã¨æ›¸ã„ã¦ã‚ã‚‹ã¨ã“ã‚ã§ã™ã€‚ã“ã“ã§ã€Œä½•ã‚‰ã‹ã®æ ¹æ‹ ãƒ»åŸºæº–ã«åŸºã¥ã„ã¦ã€ã¨è¨€ã£ã¦ãŠã‚Šã€iCloudç‹¬è‡ªã®å†…éƒ¨çš„ãªcurrentVersioné¸æŠåŸºæº–ãŒã‚ã‚‹ã“ã¨ã‚’ä»„ã‚ã‹ã—ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚’è¸ã¾ãˆã¦ã€å…¬å¼ã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºã‚µãƒ³ãƒ—ãƒ«ã®å®Ÿè£…ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚[NSFileVersion.currentVersionOfItem(at:)](https://developer.apple.com/documentation/foundation/nsfileversion/1412963-currentversionofitem)ã§æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã—ã¦ã„ã‚‹ã®ã«ã€ã‚ã–ã‚ã–ä»–ã®å…¨ã¦ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã—ã¦[modificationDate](https://developer.apple.com/documentation/foundation/nsfileversion/1411506-modificationdate)ã‚’æ¯”è¼ƒã—ã¦å‹è€…ã‚’æ±ºã‚ã‚‹è¨­è¨ˆã«ãªã£ã¦ã„ã¾ã™ã€‚

```swift
// Make the latest version current and remove the others.
//
private func pickLatestVersion(for documentURL: URL) -> Bool {
    guard let versionsInConflict = NSFileVersion.unresolvedConflictVersionsOfItem(at: documentURL),
          let currentVersion = NSFileVersion.currentVersionOfItem(at: documentURL) else {
        return false
    }
    var shouldRevert = false
    var winner = currentVersion
    for version in versionsInConflict {
        if let date1 = version.modificationDate, let date2 = winner.modificationDate,
           date1 > date2 {
            winner = version
        }
    }
    if winner != currentVersion {
        do {
            try winner.replaceItem(at: documentURL)
            shouldRevert = true
        } catch {
            print("Failed to replace version: \(error)")
        }
    }
    do {
        try NSFileVersion.removeOtherVersionsOfItem(at: documentURL)
    } catch {
        print("Failed to remove other versions: \(error)")
    }
    return shouldRevert
}
```
(https://developer.apple.com/documentation/uikit/documents_data_and_pasteboard/synchronizing_documents_in_the_icloud_environment, DetailViewController+Conflict.swift, pickLatestVersion(for:))

currentVersionOfItemãŒå¿…ãšæœ€æ–°æ—¥ä»˜ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¿”ã™ãªã‚‰ã“ã®ã‚ˆã†ãªå®Ÿè£…ã¯ä¸è¦ã®ã¯ãšã§ã™ã€‚è©³ã—ã„æ„å›³ã¯ã‚³ãƒ¼ãƒ‰æœ¬ä½“ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€ä¸Šè¨˜ã‚’åˆã‚ã›ã¦è€ƒãˆã‚‹ã¨ã€ã©ã†ã‚‚ç«¶åˆç™ºç”Ÿæ™‚ã«NSFileVersionãŒæœ€æ–°ã¨ãƒãƒ¼ã‚¯ã™ã‚‹ã®ã¯**ä½•ã‚‰ã‹ã®ç†ç”±ã§æ±ºã‚ã‚‰ã‚Œ**ã€æ›´æ–°æ—¥ã§ãƒãƒ¼ã‚¯ã•ã‚Œã‚‹è¨³ã§ã¯ãªã„ã¨ã„ã†ä»®èª¬ãŒå¼·ã¾ã‚Šã¾ã—ãŸã€‚

# å®Ÿè£…ã®ã‚¹ã‚¹ãƒ¡
ã€Œæœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»¥å¤–ã‚’å‰Šé™¤ã™ã‚‹ã€ã¨ã„ã†å®Ÿè£…ã ã¨ä¸‹è¨˜ã®ã‚ˆã†ã«ã‚·ãƒ³ãƒ—ãƒ«ã«å®Ÿè£…ã™ã‚Œã°è‰¯ã„ã¯ãšã§ã™ã€‚

```swift
do {
    let currentVersion = NSFileVersion.currentVersionOfItem(at: documentURL)
    try NSFileVersion.removeOtherVersionsOfItem(at: documentURL)
    currentVersion?.isResolved = true
} catch {
    print("error")
}
```

ãŸã ã—ã€ã“ã®è¨˜äº‹ã§ä»®èª¬ç«‹ã¦ãŸã‚ˆã†ã«ã€Œæœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã—ã¦ãƒãƒ¼ã‚¯ã•ã‚ŒãŸFIleVersionãŒæ›´æ–°æ—¥ãŒæœ€ã‚‚æ–°ã—ã„FIleVersionã§ã¯ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ã€ã¨ã—ã¦è€ƒãˆã€å¾Œå‹ã¡æˆ¦ç•¥ã‚’æ­£ã—ãå®Ÿè£…ã—ã‚ˆã†ã¨ã™ã‚‹ãªã‚‰ã€å…¬å¼ã‚µãƒ³ãƒ—ãƒ«ã¨åŒã˜ã‚ˆã†ã« [modificationDate](https://developer.apple.com/documentation/foundation/nsfileversion/1411506-modificationdate)ã®æœ€ã‚‚æ–°ã—ã„ã‚‚ã®ã‚’å‹è€…ã¨ã™ã‚‹å®Ÿè£…ã‚’è¡Œã£ãŸæ–¹ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚

# æ¤œè¨¼æ­“è¿
æ¤œè¨¼ãŒã‹ãªã‚Šå›°é›£ãªã®ã§è‡ªåˆ†ã§ä»®èª¬ã®æ¤œè¨¼ã‚’å‡ºæ¥ã¦ã„ã¾ã›ã‚“ã€‚ã‚‚ã—æ¤œè¨¼å‡ºæ¥ãŸæ–¹ã€ã‚‚ã—ãã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‘¨ã‚Šã®æ‰±ã„ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã”å­˜ã˜ã®æ–¹ãªã©ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã—ãŸã‚‰ã‚³ãƒ¡ãƒ³ãƒˆé ‚ã‘ã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™ã€‚
